name: Cleanup Preview Environment

on:
  pull_request:
    types: [closed]
    branches: [main]

env:
  PR_NUMBER: ${{ github.event.pull_request.number }}
  GITOPS_REPO: nikolay-e/gitops

jobs:
  cleanup-preview:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout gitops repository
        uses: actions/checkout@v5.0.0
        with:
          repository: ${{ env.GITOPS_REPO }}
          token: ${{ secrets.GITOPS_PAT }}
          ref: main

      - name: Remove preview Application
        run: |
          PREVIEW_DIR="clusters/previews/pr-${PR_NUMBER}"

          if [ -d "${PREVIEW_DIR}" ]; then
            echo "Removing preview environment for PR #${PR_NUMBER}"

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git rm -r "${PREVIEW_DIR}"
            git commit -m "chore: cleanup preview environment for PR #${PR_NUMBER}

          PR closed: ${{ github.event.pull_request.html_url }}

          Argo CD will automatically prune all resources via 'spec.syncPolicy.automated.prune: true'.

          ðŸ¤– Automated cleanup via GitHub Actions"

            git push origin main

            echo "âœ“ Preview directory removed from GitOps"
            echo "âœ“ Argo CD will prune all Kubernetes resources (namespace, pods, database, certificates)"
          else
            echo "No preview environment found for PR #${PR_NUMBER}"
            echo "Directory does not exist: ${PREVIEW_DIR}"
          fi

      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            const comment = `## ðŸ§¹ Preview Environment Cleanup Initiated

            The preview environment configuration has been removed from GitOps.

            **Cleanup Status:** ArgoCD is automatically pruning all resources (~2-3 minutes)

            Resources being removed via ArgoCD automated prune:
            - âœ… Namespace: \`lingua-quiz-preview-pr-${prNumber}\`
            - âœ… Database: \`linguaquiz_pr_${prNumber}\` (via Kubernetes Job)
            - âœ… Database Secret \`linguaquiz-pr-${prNumber}-db-secret\`
            - âœ… SSL Certificate \`lingua-quiz-preview-pr-${prNumber}-tls\`
            - âœ… Deployment, Service, Ingress
            - âœ… All pods and persistent volume claims

            ArgoCD prunes resources automatically when source directory is removed from Git.
            No manual intervention required.

            Thank you for using preview environments! ðŸš€
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
