name: Deploy Preview Environment

on:
  # Trigger after CI completes successfully on any PR
  workflow_run:
    workflows: ["CI"]
    types: [completed]

concurrency:
  group: preview-${{ github.event.workflow_run.pull_requests[0].number }}
  cancel-in-progress: true

env:
  GITOPS_REPO: nikolay-e/gitops

jobs:
  deploy-preview:
    # Only run on PRs when CI succeeds
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.pull_requests[0] != null
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      packages: read
      pull-requests: write
      deployments: write

    steps:
      - name: Get PR details and find image tag
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.workflow_run.pull_requests[0];
            const prNumber = pr.number;

            // Get the full PR details to access head SHA
            const { data: prData } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: 'lingua-quiz',
              pull_number: prNumber
            });

            // Security: Block fork PRs
            const isFork = prData.head.repo.fork || prData.head.repo.full_name !== context.repo.full_name;
            if (isFork) {
              core.setFailed(`PR #${prNumber} is from a fork (${prData.head.repo.full_name}). Preview deployments are not allowed for fork PRs due to security restrictions.`);
              throw new Error('Fork PR detected - preview deployment blocked');
            }

            console.log(`âœ… PR #${prNumber} is from same repository (not a fork)`);

            // Use head SHA - it's persistent and matches what CI builds
            // (CI was fixed to use head.sha instead of merge_commit_sha)
            const headSha = prData.head.sha;

            core.setOutput('number', prNumber);
            core.setOutput('head_sha', headSha);

            console.log(`PR #${prNumber}, HEAD SHA: ${headSha}`);

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify images exist
        env:
          IMAGE_TAG: ${{ steps.pr.outputs.head_sha }}
        run: |
          # shellcheck disable=SC2086
          echo "Verifying images are available for tag: ${IMAGE_TAG}"

          # Function to check if image exists with retries
          check_image() {
            local image="$1"
            local max_attempts=5
            local wait_seconds=10

            for attempt in $(seq 1 "$max_attempts"); do
              echo "Attempt ${attempt}/${max_attempts}: Checking ${image}..."
              if docker manifest inspect "$image" > /dev/null 2>&1; then
                echo "âœ“ Image found: ${image}"
                return 0
              fi

              if [ "$attempt" -lt "$max_attempts" ]; then
                echo "Image not found yet, waiting ${wait_seconds}s before retry..."
                sleep "$wait_seconds"
              fi
            done

            echo "âŒ Image not found after ${max_attempts} attempts: ${image}"
            return 1
          }

          # Check if backend image exists
          if ! check_image "ghcr.io/nikolay-e/lingua-quiz/lingua-quiz-backend:${IMAGE_TAG}"; then
            exit 1
          fi

          # Check if frontend image exists
          if ! check_image "ghcr.io/nikolay-e/lingua-quiz/lingua-quiz-frontend:${IMAGE_TAG}"; then
            exit 1
          fi

          echo "âœ“ All images verified and ready for deployment"

      - name: Checkout gitops repository
        uses: actions/checkout@v5
        with:
          repository: ${{ env.GITOPS_REPO }}
          token: ${{ secrets.GITOPS_PAT }}
          ref: main

      - name: Create preview directory
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          IMAGE_TAG: ${{ steps.pr.outputs.head_sha }}
        run: |
          PREVIEW_DOMAIN="lingua-quiz-pr-${PR_NUMBER}.nikolay-eremeev.com"

          echo "Creating preview environment for PR #${PR_NUMBER}"
          echo "  Image tag: ${IMAGE_TAG}"
          echo "  URL: https://${PREVIEW_DOMAIN}"

          # Create directory for ApplicationSet to discover
          mkdir -p "clusters/previews/pr-${PR_NUMBER}"

          # Create preview-specific Helm values file
          cat > "clusters/previews/pr-${PR_NUMBER}/values.yaml" <<EOF
          backend:
            image:
              repository: ghcr.io/nikolay-e/lingua-quiz/lingua-quiz-backend
              tag: ${IMAGE_TAG}
          frontend:
            image:
              repository: ghcr.io/nikolay-e/lingua-quiz/lingua-quiz-frontend
              tag: ${IMAGE_TAG}
          ingress:
            frontend:
              host: ${PREVIEW_DOMAIN}
            backend:
              host: # Empty for same-host deployment
          cors:
            origins:
              - https://${PREVIEW_DOMAIN}
          EOF

          # Create marker file so ApplicationSet discovers this directory
          touch "clusters/previews/pr-${PR_NUMBER}/.preview"

      - name: Commit and push
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          IMAGE_TAG: ${{ steps.pr.outputs.head_sha }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "clusters/previews/pr-${PR_NUMBER}/"

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "feat: deploy preview environment for PR #${PR_NUMBER}

          Preview URL: https://lingua-quiz-pr-${PR_NUMBER}.nikolay-eremeev.com
          Commit: ${IMAGE_TAG}

          ðŸ¤– Automated deployment via GitHub Actions"

            git push origin main
            echo "âœ“ Preview configuration committed to gitops repository"
            echo "âœ“ Argo CD will automatically sync and deploy the preview environment"
          fi

      - name: Create GitHub Deployment
        id: deployment
        uses: ./.github/actions/create-deployment
        with:
          environment: 'preview-pr-${{ steps.pr.outputs.number }}'
          ref: ${{ steps.pr.outputs.head_sha }}
          is-production: 'false'
          is-transient: 'true'
          description: 'Preview environment for PR #${{ steps.pr.outputs.number }}'
          payload: |
            {
              "pr_number": ${{ steps.pr.outputs.number }},
              "commit_sha": "${{ steps.pr.outputs.head_sha }}",
              "preview_url": "https://lingua-quiz-pr-${{ steps.pr.outputs.number }}.nikolay-eremeev.com"
            }
          environment-url: 'https://lingua-quiz-pr-${{ steps.pr.outputs.number }}.nikolay-eremeev.com'
          initial-status: 'in_progress'
          status-description: 'ArgoCD is syncing the preview environment (~2 min)'

      - name: Comment on PR
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          IMAGE_TAG: ${{ steps.pr.outputs.head_sha }}
          DEPLOYMENT_ID: ${{ steps.deployment.outputs.deployment-id }}
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);
            const imageTag = process.env.IMAGE_TAG;
            const deploymentId = process.env.DEPLOYMENT_ID;
            const previewUrl = `https://lingua-quiz-pr-${prNumber}.nikolay-eremeev.com`;
            const environmentUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/deployments`;

            const comment = `## ðŸš€ Preview Environment Deploying

            Your preview environment is being deployed!

            **Preview URL:** ${previewUrl}

            **Status:** â³ ArgoCD is syncing (~2 minutes)

            **Deployment:** [View in GitHub](${environmentUrl}) (ID: ${deploymentId})

            The deployment includes:
            - âœ… Dedicated namespace
            - âœ… Isolated database
            - âœ… SSL certificate (auto-provisioned)
            - âœ… Image: \`${imageTag}\`

            Updates will be automatic when you push new commits.
            `;

            // Find existing preview comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview Environment')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
